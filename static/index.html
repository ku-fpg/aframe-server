<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello, World! • A-Frame</title>
    <meta name="description" content="Hello, World! • A-Frame">
    <script src="https://aframe.io/releases/0.2.0/aframe.min.js"></script>
    
    <script src="js/aframe-gamepad-controls.js"></script>
    <script src="js/moga-polyfill.js"></script>

    <script src="https://code.jquery.com/jquery-2.2.3.min.js"   
            integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   
            crossorigin="anonymous"></script>
    <script type='text/javascript'    
            src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>

  </head>
  <body>

  <script>
    var x = "";
    var gui;
    $(function(){
      gui    = new dat.GUI();
      var defaults =
               { position: new THREE.Vector3( 0, 0, 0 )
               , rotation: new THREE.Vector3( 0, 0, 0 )
               , scale:    new THREE.Vector3( 1, 1, 1 )
               };
      var steps =
               { position: 0.025
               , rotation: 1
               , scale:    0.1
               };

      active = { entity: "#"
               , position: defaults.position.clone()
               , rotation: defaults.rotation.clone()
               , scale:    defaults.scale.clone()
               }
             
      var changePosition = function(value) {
        var me = $("#" + active.entity);
        me[0].setAttribute("position",active.position)
        me[0].setAttribute("rotation",active.rotation)
        me[0].setAttribute("scale",active.scale)
      }
      for (i in defaults) {
        var folder = gui.addFolder(i)
        var xyz = ['x','y','z']
        for(j in xyz) {
          console.log(i,j,active[i])
          folder.add(active[i],xyz[j]).step(steps[i]).listen().onChange(changePosition);
        }
      }

      console.log("Here");
      debug = {}
      var url = window.location
      
      // Insert a marker. Above the marker is HTML we have inserted, and below the marker is auto-generated.
      //      $("a-scene").prepend("<div aframe-marker></div>");

      var reloadGUI = function() {
        // We already have a gui object
        var ids = []
        $("a-scene [id]").each(function(x,y) { ids.push($(y).attr("id")); });
        if (ids.length == 0) {
          return
        }
        console.log(ids)

        var changeEntity = function(value) {
          console.log("reloadGUI.entity",value,$("#" + value))
          var me = $("#" + value);
          function fillAttr(attr) {
            var a = me[0].getAttribute(attr)
            if (a == null) {
              a = defaults[attr]
            }
            for (i in active[attr]) {
              active[attr][i] = a[i]
            }
          }
          fillAttr("position")
          fillAttr("rotation")
          fillAttr("scale")
/*
          var position = me[0].getAttribute("position")
          if (position == null) {
            position = {x: 0, y: 0, z: 0};
          }
          active.position.x = position.x
          active.position.y = position.y
          active.position.z = position.z
*/
        };
        active.entity = ids[0]
        changeEntity(active.entity)
        reloadGUI.entity = gui.add(active, 'entity', ids );
        reloadGUI.entity.onChange(changeEntity);
//        reloadGUI.entity.add(active,'entity', ['A','B'])
      }

      debug.reloadGUI = reloadGUI
      // Every second, update the scene
      var sceneText = "";
      var resetScene = function(data) {
//        console.log("checking")
        if (data == sceneText) {
            setTimeout(loadScene,1000)
            return;
        }
        sceneText = data;
        x = sceneText;
        
        if ($("a-scene").length == 0) {
          $("body").prepend(data);
        } else {
          var ch = $("a-scene").children();
          for(i = 0;i < ch.length;i++) {
            if (!ch[i].localName
                  || ch[i].localName == "canvas"
                  || ch[i].localName == "div"
                  || !ch[i].attributes
                  || ch[i].attributes["data-aframe-default-light"]
                  || ch[i].attributes["data-aframe-default-camera"]
            ) {
//              console.log("leaving " + i);
            } else {
//              console.log("removing " + i)
              // This appears to be leaving the Three.js Gemoetries behind. 
              // TODO: check into this
              $(ch[i]).remove()
            }
          }
//          console.log("childern",$("a-scene").children())
          // repace a-scene with x-scene to avoid triggering the a-scene callback
          // (which inserts the defaults, and therefor makes two camera, which confuses
          //  the THREE.js sub-system). Note replace only replaces the *first* 
          // a-scene of the string, so will not effect any properties.
          var xml = $(data.replace("a-scene","x-scene"));
          console.log(xml)
          xml.children().prependTo("a-scene");
          $("a-scene").attr("version",xml.attr("version"))  // update the version number
        }
        reloadGUI()
        setTimeout(loadScene,1000)
      }
      var updateScene = function(d) {
        console.log("updateScene",d)
        if (d.change && d.change == "HEAD") {
          return loadScene();
        } else {
          loadScene("RELOAD");
        }
      }
      var loadScene = function(ty) {
        var version = $("a-scene").attr("version");
        if (version == undefined || ty == "RELOAD") {
          // do this the slow way
          $.get( "/scene", resetScene);
        } else {
          // check for changes
          $.getJSON( "/scene/" + version, updateScene);          
        }
      }
      loadScene("RELOAD")
    });

  </script>
  </body>
</html>
